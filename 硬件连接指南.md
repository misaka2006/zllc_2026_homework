# 🔌 PS2麦克纳姆轮小车硬件连接完整指南

## 📋 项目概述

本项目为基于STM32F103C8T6的麦克纳姆轮四驱小车控制系统，搭载NVIDIA Jetson TX2作为上位机，支持PS2手柄与串口双模式控制。

### 核心配置
- **主控芯片**: STM32F103C8T6 (ARM Cortex-M3, 72MHz)
- **上位机**: NVIDIA Jetson TX2
- **电源**: 3S 18650锂电池组 (11.1V, 2500mAh)
- **电机**: 4×JGB37-520减速电机（带编码器，配麦克纳姆轮）
- **驱动**: 2×L298N双路H桥驱动模块
- **驱动方式**: 四轮独立控制（L298N#1:前轮LF+RF，L298N#2:后轮LB+RB）
- **舵机**: 3×MG996R舵机（180度标准舵机）
- **控制模式**: 麦克纳姆轮全向移动 + 3舵机独立控制

---

## 📍 引脚速查（对应引脚图）

| STM32 引脚 | 引脚图标注 | 连接外设 | 说明 |
|------------|-------------|-----------|------|
| PA0 / PA1 | LF_IN1 / LF_IN2 | L298N#1 左前电机方向 | 推挽输出 |
| PA2 / PA3 | RF_IN1 / RF_IN2 | L298N#1 右前电机方向 | 推挽输出 |
| PA4 / PA5 | LB_IN1 / LB_IN2 | L298N#2 左后电机方向 | 推挽输出 |
| PA6 / PA7 | RB_IN1 / RB_IN2 | L298N#2 右后电机方向 | 推挽输出 |
| PA8 / PA9 / PA10 / PA11 | TIM1_CH1~4 | 四轮 PWM（LF/LB/RF/RB） | 1 kHz，PA8 单独引出 |
| PB6 / PB7 / PB8 | TIM4_CH1~3 | 舵机 1~3 信号 | 50 Hz |
| PB9 | 预留/GND隔离 | 作为 PB15 与 PA8 之间的间隔脚 | 推荐接地 |
| PB10 / PB11 | UART_TX / UART_RX | USART3 → 上位机 | 图中灰色标注 |
| PB12 / PB13 / PB14 / PB15 | PS2_DI / PS2_CMD / PS2_CS / PS2_CLK | PS2 接收器 | 软 SPI |
| PA15 / PB3 | ENC_L_A / ENC_L_B | 左侧编码器并联 | TIM2 |
| PB4 / PB5 | ENC_R_A / ENC_R_B | 右侧编码器并联 | TIM3 |
| PA13 / PA14 | SYS_JTMS-SWDIO / SYS_JTCK-SWCLK | SWD 调试接口 | 连接 ST-LINK |
| PA12 | VBUS | 预留 | 保持浮空 |

> 以上引脚命名、颜色与图片一致，查线时可快速对照；其余电源、BOOT、晶振保持原设计即可。

---

### 连接器排布建议（PA8 重新分组）

- **PS2 6Pin 接口**：按照 `5V - GND - PB12 - PB13 - PB14 - PB15` 排列，并靠近板右上角放置，PB15 只在该接口出现。  
- **电机 PWM 排针**：PA8 从原排针中移到新位置，顺序建议为 `PA8 - GND - PA9 - PA10 - PA11`，同时在 PS2 接口与该排针之间插入接地的 PB9 作为“隔离针”，避免 PB15 与 PA8 相邻。  
- **舵机排针**：仅保留 PB6/PB7/PB8 三组 3Pin，移至板左侧，远离 PS2 与 PWM 排针，降低串扰。  

这样可满足“PB15 与 PA8 不能相邻”的布线约束，同时维持原电机 PWM 及 PS2 功能。

---

## ⚡ 供电系统设计

### 整体架构

```
3S 18650电池组 (11.1V, 2500mAh)
    │
    ├─── 30A保险丝 ─── SS54防反接二极管 ─── 主开关
    │
    ├────────────────┬─────────────────┬──────────────┐
    │                │                 │              │
    ▼                ▼                 ▼              ▼
[LM2596-5V/4A]  [LM2596-5V/3A]   [L298N#1]      [L298N#2]
 (TX2专用)       (STM32系统)     (VCC直供)      (VCC直供)
    │                │
    ▼                ▼
  TX2 5V      [RT9013-3.3V/500mA]
                     │
                     ▼
                STM32核心供电
```

### 1. 主电源分配

#### 电池组规格
- **型号**: INR18650-25P (EVE亿纬锂能)
- **配置**: 3S串联
- **电压**: 11.1V标称，12.6V满电，8.25V截止
- **容量**: 2500mAh
- **最大放电**: 30A (12C)

#### 保护电路
```
电池正极 → 30A自恢复保险丝 → SS54肖特基二极管 → 主开关 → 各模块
电池负极 → 系统公共地
```

**关键元件:**
- 30A保险丝座: 过流保护
- SS54二极管: 5A/40V，防止电池反接
- 30A主开关: 总电源控制

---

### 2. TX2供电模块 (5V/4A)

#### LM2596HV降压模块配置

```
输入: 11.1V (8.25V~12.6V)
输出: 5V / 4A

连接:
    IN+  ← 主开关输出 (16AWG)
    IN-  ← 电池负极
    OUT+ → TX2 J21 Pin1/2 (5V供电)
    OUT- → TX2 J21 Pin14 (GND)

输出滤波电容:
    220μF/16V 低ESR × 2 (并联)
    + 100μF/10V × 1
    + 0.1μF/50V × 3
```

**调压步骤:**
1. 输入11.1V电压
2. 万用表测量输出端
3. 调节电位器至5.00V±0.05V
4. 用指甲油固定电位器

---

### 3. STM32系统供电

#### 3.1 LM2596降压模块 (5V/3A)

```
输入: 11.1V
输出: 5.0V / 3A

用途:
    ├─ RT9013稳压器输入
    ├─ PS2接收器 (5V/50mA)
    ├─ L298N#1 逻辑电源 (5V/50mA)
    └─ L298N#2 逻辑电源 (5V/50mA)

输出电容:
    470μF/10V × 1
    + 100μF/10V × 2
    + 0.1μF/50V × 4
```

#### 3.2 RT9013-33稳压器 (3.3V/500mA)

**推荐使用RT9013而非AMS1117的原因:**
- 压差更小: 200mV vs 1V
- 发热更少: 适合5V→3.3V
- 效率更高: >90%
- 空载电流更低: <5μA

**SOT-23-5封装引脚定义:**
```
原理图参考:
     ┌─────────────┐
  1──│VIN    VOUT│──5
  3──│CE      NC │──4
  2──│GND        │
     └─────────────┘
```

**详细连接方案:**
```
输入端:
    Pin1 (VIN)  ← LM2596输出5.0V
    Pin3 (CE)   ← 5V (使能，接VIN)
    Pin2 (GND)  ← 系统公共地
    
输出端:
    Pin5 (VOUT) → STM32所有VDD引脚 (3.3V)
    Pin4 (NC)   → 悬空（内部无连接）

输入端电容 (0603):
    C_IN: 10μF X5R (距离VIN引脚<5mm)
    + 0.1μF陶瓷电容（高频滤波）
    
输出端电容 (0603):
    C_OUT: 10μF × 2 (并联，距离VOUT引脚<5mm)
    + 1μF × 1
    + 0.1μF × 3 (分布到各STM32 VDD引脚)

晶振接口XH2.54端子:
    CN1 (输入): 
        Pin1 → VIN (5V)
        Pin2 → GND
    
    CN2 (输出):
        Pin1 → VOUT (3.3V)
        Pin2 → GND
```

**PCB布局要点:**
1. 输入电容尽量靠近Pin1
2. 输出电容尽量靠近Pin5
3. GND通过铺铜大面积连接
4. 走线宽度：VIN≥0.5mm，VOUT≥0.3mm
5. 热焊盘通过过孔连接底层地平面散热

---

## 🚗 电机驱动系统

### 麦克纳姆轮布局

**重要说明**：麦克纳姆轮安装方向（俯视图）
```
   左前LF ╱     ╲ 右前RF
         ┌───────┐
         │       │
         │  车体  │
         │       │
         └───────┘
   左后LB ╲     ╱ 右后RB

滚子方向：
  - 左前(LF): 滚子朝向右前 ╱
  - 右前(RF): 滚子朝向左前 ╲
  - 左后(LB): 滚子朝向右后 ╲
  - 右后(RB): 滚子朝向左后 ╱
```

### L298N模块配置

**关键说明**：
- 本项目使用**四轮独立控制**，每个轮子都可以独立控制
- L298N#1控制前轮（左前LF + 右前RF）
- L298N#2控制后轮（左后LB + 右后RB）
- 每个轮子都有独立的方向控制和PWM调速，实现麦克纳姆轮全向移动

#### L298N#1 (前轮组)

```
电源连接:
    VCC  ← 11.1V电池 (16AWG硅胶线)
    GND  ← 电池负极
    +5V  ← LM2596#2输出 (逻辑电源)

左前电机 (LF) 控制:
    ENA  ← PB6 (TIM4_CH1, 1kHz PWM)
    IN1  ← PA0 (方向控制位1)
    IN2  ← PA1 (方向控制位2)
    
    OUT1 → 左前电机 M+ (红线)
    OUT2 → 左前电机 M- (黑线)

右前电机 (RF) 控制:
    ENB  ← PB8 (TIM4_CH3, 1kHz PWM)
    IN3  ← PA2 (方向控制位1)
    IN4  ← PA3 (方向控制位2)
    
    OUT3 → 右前电机 M+ (红线)
    OUT4 → 右前电机 M- (黑线)

注意:
    - 每个电机都有独立的PWM控制，实现精确的速度控制
    - 四个轮子可以独立控制，实现麦克纳姆轮的全向移动
```

#### L298N#2 (后轮组)

```
电源连接:
    VCC  ← 11.1V电池
    GND  ← 电池负极
    +5V  ← LM2596#2输出

左后电机 (LB) 控制:
    ENA  ← PB7 (TIM4_CH2, 1kHz PWM)
    IN1  ← PA4 (方向控制位1)
    IN2  ← PA5 (方向控制位2)
    
    OUT1 → 左后电机 M+ (红线)
    OUT2 → 左后电机 M- (黑线)

右后电机 (RB) 控制:
    ENB  ← PB9 (TIM4_CH4, 1kHz PWM)
    IN3  ← PA6 (方向控制位1)
    IN4  ← PA7 (方向控制位2)
    
    OUT3 → 右后电机 M+ (红线)
    OUT4 → 右后电机 M- (黑线)

注意:
    - 每个电机都有独立的PWM控制，实现精确的速度控制
    - 四个轮子可以独立控制，实现麦克纳姆轮的全向移动
```

### 麦克纳姆轮全向移动控制

**基本运动模式：**
```
前进:      LF+ RF+ LB+ RB+  (四轮同速前转)
后退:      LF- RF- LB- RB-  (四轮同速后转)
左平移:    LF- RF+ LB+ RB-  (左前/右后反转，右前/左后正转)
右平移:    LF+ RF- LB- RB+  (左前/右后正转，右前/左后反转)
原地左转:  LF- RF+ LB- RB+  (左轮反转，右轮正转)
原地右转:  LF+ RF- LB+ RB-  (左轮正转，右轮反转)
左前斜移:  LF0 RF+ LB+ RB0  (右前/左后正转，左前/右后停止)
右前斜移:  LF+ RF0 LB0 RB+  (左前/右后正转，右前/左后停止)
左后斜移:  LF- RF0 LB0 RB-  (左前/右后反转，右前/左后停止)
右后斜移:  LF0 RF- LB- RB0  (右前/左后反转，左前/右后停止)

说明: 
  + = 正转, - = 反转, 0 = 停止
  LF = 左前轮, RF = 右前轮
  LB = 左后轮, RB = 右后轮
```

**⚠️ 重要设置:**
- **移除所有ENA/ENB跳线帽** (4个通道都要移除！)
- **移除板载5V稳压跳线帽**
- VCC端只接11.1V电池，不接5V
- 建议在IN引脚串联1kΩ限流电阻
- **确保麦克纳姆轮安装方向正确**
- **确保每个电机的正反转方向正确**

---

## 🤖 舵机控制系统

### MG996R舵机配置

**舵机规格:**
- 型号: MG996R (金属齿轮数字舵机)
- 工作电压: 4.8V~7.2V (推荐5V供电)
- 转动范围: 0~180度 (标准舵机)
- 扭矩: 9.4kg·cm (4.8V) / 11kg·cm (6V)
- 速度: 0.17秒/60度 (4.8V)

### 舵机引脚分配（3 路）

```
舵机控制 (TIM1 PWM, 50Hz) —— 仅使用 CH1~CH3:

舵机#1:
    信号线 (黄/白) ← PA8 (TIM1_CH1)
    VCC (红)        ← 5V (来自LM2596#2)
    GND (棕/黑)    ← 系统公共地

舵机#2:
    信号线 (黄/白) ← PA9 (TIM1_CH2)
    VCC (红)        ← 5V
    GND (棕/黑)    ← GND

舵机#3:
    信号线 (黄/白) ← PA10 (TIM1_CH3)
    VCC (红)        ← 5V
    GND (棕/黑)    ← GND

注意：PA11 (TIM1_CH4) 保留未使用，PA8与PB15(PS2_CLK)已分开，避免干扰。
```

### PWM信号参数

```
TIM1配置（舵机用）:
    频率: 50Hz (周期20ms)
    Prescaler: 71
    Period: 19999
    
脉宽与角度对应:
    0.5ms (500μs)   → 0度
    1.5ms (1500μs)  → 90度 (中位)
    2.5ms (2500μs)  → 180度
    
公式: 脉宽(μs) = 500 + (角度 / 180) × 2000
```

### PS2手柄控制映射

```
舵机控制按键分配:
    舵机#1: UP键(正转) + DOWN键(反转)
    舵机#2: LEFT键(正转) + RIGHT键(反转)
    舵机#3: △键(正转) + ×键(反转)

控制参数:
    每次按键移动角度: 2度
    更新间隔: 20ms
    角度范围: 0度 ~ 180度 (标准舵机范围)
    安全范围: 30度 ~ 150度 (实际使用建议范围)
```

**⚠️ 注意事项:**
1. MG996R为180度标准舵机，不支持超过180度转动
2. 设置30~150度范围留出安全余量，防止堵转
3. 舵机供电必须使用外部5V电源，不能直接用STM32供电
4. 建议在每个舵机VCC引脚附近添加100μF电容防止电压波动
5. 信号线建议不超过30cm，否则需加屏蔽线

---

## 🎮 PS2手柄接收器

### 接口连接

```
PS2接收器 → STM32F103C8T6

电源:
    VCC  ← 5V (来自LM2596#2)
    GND  ← 系统公共地

信号 (GPIO模拟SPI):
    DI   ← PB12 (数据输入)
    DO   → 悬空或接GND
    CS   ← PB14 (片选)
    CLK  ← PB15 (时钟)
    CMD  ← PB13 (命令)
```

**通信协议:** 
- 软件模拟SPI通信
- 轮询周期: 20ms
- 数据格式: 9字节 (见ax_ps2.h)

---

## 🔄 编码器接口

**重要原理**：
- 麦克纳姆轮四轮独立控制，但同侧编码器并联用于速度反馈
- 左侧（LF+LB）编码器并联，提供左侧速度反馈
- 右侧（RF+RB）编码器并联，提供右侧速度反馈
- 并联编码器计数 = 两个电机转速的平均值

### 左侧编码器 (TIM2)

```
接线方式: 左前+左后电机编码器并联

具体连接:
    左前电机ENC_A ─┐
                      ├─ 220Ω保护电阻 → PA15 (TIM2_CH1)
    左后电机ENC_A ─┘
    
    左前电机ENC_B ─┐
                      ├─ 220Ω保护电阻 → PB3  (TIM2_CH2)
    左后电机ENC_B ─┘
    
    所有ENC_VCC    ── 3.3V
    所有ENC_GND    ── 系统公共地
```

### 右侧编码器 (TIM3)

```
接线方式: 右前+右后电机编码器并联

具体连接:
    右前电机ENC_A ─┐
                      ├─ 220Ω保护电阻 → PB4 (TIM3_CH1)
    右后电机ENC_A ─┘
    
    右前电机ENC_B ─┐
                      ├─ 220Ω保护电阻 → PB5 (TIM3_CH2)
    右后电机ENC_B ─┘
    
    所有ENC_VCC    ── 3.3V
    所有ENC_GND    ── 系统公共地
```

**配置参数:**
- 编码器模式: TI12 (四倍频)
- 计数范围: 0-65535 (16位)
- 内部上拉: 已启用
- 滤波: IC1 Filter=6

**注意事项:**
1. 同侧电机编码器A相并联、B相并联
2. 并联节点到STM32之间加220Ω保护电阻
3. 使用屏蔽双绞线，屏蔽层接地
4. 如编码器是5V输出，需加分压电阻（3.3K和6.8K分压）
5. 编码器并联后计数速度约为单个电机的2倍
6. 左右编码器用于速度闭环控制，保证直线行驶稳定性

---

## 📡 TX2与STM32串口通信

### J21扩展口连接

```
TX2 J21引脚 → 功能 → STM32引脚
─────────────────────────────────
Pin1/2 (5V)    电源   → 独立LM2596供电
Pin14  (GND)   地线   → 系统公共地
Pin8   (TX)    发送   → PB11 (USART3_RX)
Pin10  (RX)    接收   ← PB10 (USART3_TX)
Pin9   (GND)   地线   → GND
```

### 串口配置参数

```
波特率: 115200
数据位: 8
停止位: 1
校验位: None
流控:   None
```

### 电平匹配检查

**TX2 UART电平可能是1.8V，需确认:**

1. 用万用表测量TX2 J21 Pin8电压
2. 如果是3.3V → 可直接连接
3. 如果是1.8V → 需要电平转换

**电平转换方案 (如需要):**

```
使用 TXS0108E 双向电平转换器

连接:
    VCCA (1.8V侧) ← TX2的1.8V电源
    VCCB (3.3V侧) ← STM32的3.3V
    GND           ← 公共地
    
    A1 ← TX2 Pin8  (TX, 1.8V)
    B1 → PB11      (RX, 3.3V)
    
    A2 → TX2 Pin10 (RX, 1.8V)
    B2 ← PB10      (TX, 3.3V)
```

---

## 🔌 STM32最小系统

### 电源引脚

```
3.3V供电 (来自RT9013):
    VDD  (Pin1, 9, 24, 48) ← 3.3V
    VDDA (Pin9)            ← 3.3V (模拟电源)

地线:
    VSS  (Pin8, 23, 35, 47) ← GND
    VSSA (Pin8)             ← GND (模拟地)

去耦电容 (0603, 每个VDD附近):
    0.1μF × 4 (距离<5mm)
    10μF  × 1 (VDDA专用)
```

### 复位电路

```
NRST (Pin7):
    ├─ 10kΩ上拉到3.3V
    ├─ 0.1μF电容到GND
    └─ 复位按键到GND
```

### 启动配置

```
BOOT0 (Pin44) ── 10kΩ下拉 ── GND  (Flash启动)
BOOT1 (Pin20) ── 10kΩ下拉 ── GND
```

### 晶振电路

```
8MHz无源晶振:
    OSC_IN  (PD0, Pin5)  ← 晶振Pin1 + 20pF到GND
    OSC_OUT (PD1, Pin6)  ← 晶振Pin2 + 20pF到GND
```

---

## 📊 完整引脚分配表

| 功能分类 | STM32引脚 | 连接目标 | 说明 |
|---------|----------|---------|------|
| **电机控制 (四轮独立控制)** ||||
| 左前电机方向1 | PA0 | L298N#1 IN1 | GPIO推挽输出 |
| 左前电机方向2 | PA1 | L298N#1 IN2 | GPIO推挽输出 |
| 右前电机方向1 | PA2 | L298N#1 IN3 | GPIO推挽输出 |
| 右前电机方向2 | PA3 | L298N#1 IN4 | GPIO推挽输出 |
| 左后电机方向1 | PA4 | L298N#2 IN1 | GPIO推挽输出 |
| 左后电机方向2 | PA5 | L298N#2 IN2 | GPIO推挽输出 |
| 右后电机方向1 | PA6 | L298N#2 IN3 | GPIO推挽输出 |
| 右后电机方向2 | PA7 | L298N#2 IN4 | GPIO推挽输出 |
| 左前电机PWM | PB6 | L298N#1 ENA | TIM4_CH1, 1kHz |
| 左后电机PWM | PB7 | L298N#2 ENA | TIM4_CH2, 1kHz |
| 右前电机PWM | PB8 | L298N#1 ENB | TIM4_CH3, 1kHz |
| 右后电机PWM | PB9 | L298N#2 ENB | TIM4_CH4, 1kHz |
| **舵机控制** ||||
| 舵机1 PWM | PA8 | MG996R #1信号线 | TIM1_CH1, 50Hz |
| 舵机2 PWM | PA9 | MG996R #2信号线 | TIM1_CH2, 50Hz |
| 舵机3 PWM | PA10 | MG996R #3信号线 | TIM1_CH3, 50Hz |
| **编码器** ||||
| 左侧编码器A | PA15 | 左前+左后 ENC_A并联 | TIM2_CH1 编码器模式 |
| 左侧编码器B | PB3 | 左前+左后 ENC_B并联 | TIM2_CH2 编码器模式 |
| 右侧编码器A | PB4 | 右前+右后 ENC_A并联 | TIM3_CH1 编码器模式 |
| 右侧编码器B | PB5 | 右前+右后 ENC_B并联 | TIM3_CH2 编码器模式 |
| **串口通信** ||||
| USART3_TX | PB10 | TX2 J21 Pin10 | 115200波特率 |
| USART3_RX | PB11 | TX2 J21 Pin8 | 中断接收 |
| **PS2手柄** ||||
| PS2数据 | PB12 | PS2接收器DI | GPIO输入 |
| PS2命令 | PB13 | PS2接收器CMD | GPIO输出 |
| PS2片选 | PB14 | PS2接收器CS | GPIO输出 |
| PS2时钟 | PB15 | PS2接收器CLK | GPIO输出 |
| **系统** ||||
| 晶振输入 | PD0 | 8MHz晶振 | HSE |
| 晶振输出 | PD1 | 8MHz晶振 | HSE |
| 复位 | NRST | 复位电路 | - |
| 启动模式0 | BOOT0 | GND (下拉) | Flash启动 |

---

## 🛠️ 接线规范

### 线材规格要求

| 用途 | 线径 | 颜色标准 | 长度建议 |
|------|------|---------|---------|
| 电池主线 | 16AWG (1.5mm²) | 红/黑 | 15cm |
| 5V电源 | 20AWG (0.5mm²) | 红/黑 | 20cm |
| 3.3V电源 | 22AWG | 红/黑 | 10cm |
| PWM信号 | 26AWG | 黄/橙 | 30cm |
| 编码器 | 屏蔽双绞线 | - | 40cm |
| 电机线 | 20AWG | 红/黑 | 30cm |

### 共地要求

**所有模块GND必须连接 (星形拓扑):**

```
          系统公共地汇集点
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
电池GND    L298N GND    LM2596 GND
    │            │            │
    ▼            ▼            ▼
STM32 GND   TX2 GND     PS2 GND
```

**地线阻抗:** 任意两点间 < 0.5Ω

---

## 🔋 功耗估算与续航

### 峰值功耗分析

```
模块            电压    电流    功率
────────────────────────────────────
TX2满载         5V      3.0A    15W
STM32系统       5V      0.3A    1.5W
PS2接收器       5V      0.05A   0.25W
四电机峰值      11.1V   4.0A    44W
L298N损耗       -       -       8W
────────────────────────────────────
总计峰值                        ~69W
```

### 电池续航时间

```
电池容量: 2500mAh × 11.1V = 27.75Wh

续航时间 (效率按80%计算):
  满负载70W:  27.75Wh ÷ 70W × 0.8 = 19分钟
  中等40W:    27.75Wh ÷ 40W × 0.8 = 33分钟
  轻载20W:    27.75Wh ÷ 20W × 0.8 = 66分钟
```

**建议:**
- 准备2-3组电池轮换
- 添加电池电压监测 (ADC)
- 低压报警阈值: 9.6V (3.2V/节)

---

## ⚠️ 安全注意事项

### 上电前检查清单

- [ ] 电池电压在11.1V-12.6V范围
- [ ] 主电源线无短路 (万用表电阻>10kΩ)
- [ ] 3.3V轨无短路
- [ ] 5V轨无短路
- [ ] L298N跳线帽已移除
- [ ] 所有电解电容极性正确
- [ ] SS54二极管方向正确
- [ ] 所有IC芯片方向正确

### 首次上电步骤

1. **断开所有负载**，仅测试电源
2. 接入电池，打开主开关
3. 测量LM2596#1输出 = 5.0V±0.1V
4. 测量LM2596#2输出 = 5.0V±0.1V
5. 测量RT9013输出 = 3.3V±0.05V
6. 测量STM32各VDD引脚 = 3.3V
7. 触摸IC芯片，确认无异常发热
8. 逐步连接负载，每步测试

### 故障保护

```
保护措施            触发条件        动作
──────────────────────────────────────
30A保险丝           过流>30A        断开
SS54二极管          反接            阻断
低压报警            <9.6V           蜂鸣提示
过温保护            >85℃           软件限流
```

---

## 📝 测试验证流程

### 阶段1: 电源系统测试

```bash
1. 电源输出测试
   □ LM2596#1 输出 5.0V
   □ LM2596#2 输出 5.0V  
   □ RT9013 输出 3.3V
   □ 纹波 <100mV (示波器)

2. 负载测试
   □ TX2正常启动
   □ STM32工作正常
   □ 静态电流 <200mA
```

### 阶段2: STM32功能测试

```bash
1. 基础测试
   □ 烧录Bootloader成功
   □ LED闪烁程序运行
   □ 串口输出"Hello"
   
2. 外设测试
   □ TIM1 PWM输出正常 (示波器)
   □ TIM2/TIM3 编码器计数
   □ USART3 收发数据
   □ GPIO控制L298N
```

### 阶段3: 电机驱动测试

```bash
1. 单电机测试
   □ 每个电机独立前进/后退方向正确
   □ PWM调速线性
   □ 编码器计数正确
   
2. 麦克纳姆轮基本运动
   □ 前进/后退稳定
   □ 左右平移流畅
   □ 原地旋转平稳
   
3. 麦克纳姆轮全向移动
   □ 左前/右前/左后/右后斜向移动
   □ 任意方向平滑切换
   □ 组合动作执行准确
```

### 阶段4: 通信测试

```bash
1. PS2手柄
   □ 手柄成功配对
   □ 摇杆数据读取
   □ 按键响应正常
   
2. TX2串口
   □ 发送指令到STM32
   □ STM32回传数据
   □ 波特率115200稳定
```

---

## 🆘 常见问题排查

### 问题1: STM32不工作

**症状:** 无串口输出，LED不亮

**排查步骤:**
1. 测量VDD引脚电压 = 3.3V?
2. 测量晶振是否起振 (示波器)
3. 检查BOOT0是否接GND
4. 检查NRST是否上拉
5. 重新烧录程序

### 问题2: 电机不转

**症状:** 控制信号正常，电机无响应

**排查步骤:**
1. 检查L298N跳线帽是否移除（4个通道都要检查）
2. 测量ENA/ENB引脚PWM信号（PA8/PA9/PA10/PA11）
3. 测量L298N VCC = 11.1V?
4. 测量L298N逻辑5V = 5.0V?
5. 检查电机接线极性
6. 手动短接IN引脚测试每个电机
7. 检查四轮独立控制引脚分配是否正确

### 问题3: 舵机不动或抖动

**症状:** 舵机无响应或抖动不停

**排查步骤:**
1. 检查舵机供电 = 5.0V?
2. 测量PWM信号（PB6/PB7/PB8/PB9）
3. 示波器检查PWM频率 = 50Hz?
4. 检查脉宽范围在500~2500μs内
5. 更换舵机测试
6. 检查是否超出0~180度范围

### 问题4: 转向不灵敏

**症状:** 小车转弯半径过大或不转弯

**排查步骤:**
1. 检查四轮独立控制引脚是否正确
2. 测试四个轮子是否可以独立控制
3. 检查电机方向是否一致
4. 调整PWM差速比例
5. 检查编码器反馈

### 问题6: 麦克纳姆轮运动异常

**症状:** 平移时打转，或直行时偏移

**排查步骤:**
1. 检查麦克纳姆轮安装方向（滚子朝向）
2. 确认轮子布局符合俯视图
3. 检查四个电机方向是否正确
4. 测试单独控制每个轮子
5. 检查编码器反馈是否左右对称
6. 调整运动学公式中的速度系数

### 问题3: PS2手柄连接失败

**症状:** 串口输出Mode=0x00

**排查步骤:**
1. PS2接收器5V供电正常?
2. 检查引脚连接 (DI/CMD/CS/CLK)
3. 手柄是否配对 (红灯常亮)
4. 更换手柄电池
5. 检查代码延时参数

### 问题4: 编码器计数异常

**症状:** 计数不变或乱跳

**排查步骤:**
1. 编码器供电3.3V稳定?
2. 信号线是否使用屏蔽线
3. 检查TIM2/TIM3配置
4. 示波器观察A/B相波形
5. 测试电机转动方向

### 问题5: TX2通信失败

**症状:** 串口无数据交互

**排查步骤:**
1. 确认波特率115200
2. TX/RX是否交叉连接
3. GND是否共地
4. 电平是否匹配 (3.3V or 1.8V)
5. 用串口助手单独测试

---

## 📚 相关文档

- [焊接教程](./焊接教程.md) - 详细的硬件焊接指南
- [CubeMX配置说明.md](./CubeMX配置说明.md) - STM32外设配置
- [上位机使用说明.md](./上位机使用说明.md) - TX2控制接口
- [快速开始指南.md](./快速开始指南.md) - 快速入门

---

## 📞 技术支持

如有问题，请检查：
1. 所有连接是否按本文档执行
2. 电压是否在规定范围
3. 焊接质量是否合格
4. 代码版本是否最新

---

**文档版本:** v5.0  
**更新日期:** 2025-11-13  
**适用硬件:** STM32F103C8T6 + TX2 + 3S电池 + 四轮独立控制 + 4舵机MG996R配置

## 📐 麦克纳姆轮安装要点

### 滚子方向验证

**从上方俯视，滚子应该形成"X"型：**
```
     前方
      ↑
  ╱       ╲     ← 滚子方向
 ╱         ╲
╱    车体    ╲
╲           ╱
 ╲         ╱
  ╲       ╱     ← 滚子方向
```

**验证方法：**
1. 将小车放在平面上
2. 手动推动测试：
   - 前后推动应顺畅
   - 左右推动应顺畅（验证麦克纳姆轮工作）
   - 斜向推动应顺畅
3. 如果某个方向阻力大，检查轮子安装方向

### 电机接线极性

**重要：** 由于麦克纳姆轮的特殊性，左右两侧电机可能需要反向接线

**测试步骤：**
1. 运行前进指令
2. 观察四个轮子转向：
   - 从上往下看，所有轮子应该向前转
   - 如果某个轮子反向，交换该电机的M+和M-
3. 重复测试直到所有轮子转向一致

### 调试技巧

**使用串口监视器观察：**
```c
// 在main.c中添加调试输出
printf("LF:%d RF:%d LB:%d RB:%d\r\n", lf_pwm, rf_pwm, lb_pwm, rb_pwm);
printf("L_ENC:%ld R_ENC:%ld\r\n", left_count, right_count);
```

**单轮测试程序（四轮独立控制）:**
```c
// 测试单个轮子
Mecanum_Control(300, 0, 0, 0);  // 仅左前轮
HAL_Delay(1000);
Mecanum_Control(0, 300, 0, 0);  // 仅右前轮
HAL_Delay(1000);
Mecanum_Control(0, 0, 300, 0);  // 仅左后轮
HAL_Delay(1000);
Mecanum_Control(0, 0, 0, 300);  // 仅右后轮
HAL_Delay(1000);

// 测试基本运动
Car_Forward(300);     // 前进
HAL_Delay(1000);
Car_Backward(300);    // 后退
HAL_Delay(1000);
Car_Move_Left(300);   // 左平移
HAL_Delay(1000);
Car_Move_Right(300);  // 右平移
HAL_Delay(1000);
Car_TurnLeft(300);    // 原地左转
HAL_Delay(1000);
Car_TurnRight(300);   // 原地右转
HAL_Delay(1000);

// 测试舵机
Servo_SetAngle(SERVO_1, 90);  // 舵机1中位
HAL_Delay(500);
Servo_SetAngle(SERVO_1, 30);  // 最小角度
HAL_Delay(500);
Servo_SetAngle(SERVO_1, 150); // 最大角度
HAL_Delay(500);
```
